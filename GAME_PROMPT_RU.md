# ПРОМПТ ДЛЯ ОПИСАНИЯ ИГРЫ "ДОЛГОВАЯ ЯМА"

## ОБЩЕЕ ОПИСАНИЕ ПРОЕКТА

Это **2D изометрическая ролевая игра (RPG)** в жанре roguelike с элементами подземелий, созданная на **React + TypeScript + Canvas API**. Игра использует **Vite** как сборщик и **lucide-react** для иконок UI.

**Название проекта:** "долговая-яма" (из package.json)

**Технологический стек:**
- React 19.2.1
- TypeScript 5.8.2
- Vite 6.2.0
- Canvas API для рендеринга
- LocalStorage для сохранения прогресса

---

## СТРУКТУРА ПРОЕКТА

### Основные директории и файлы:

```
├── components/
│   ├── Game.tsx          # Основной игровой компонент (6500+ строк)
│   ├── MainMenu.tsx      # Главное меню с выбором класса
│   ├── MapEditor.tsx     # Редактор карт для стартовой локации
│   └── UI/
│       └── HUD.tsx       # Интерфейс игры (инвентарь, магазин, таланты)
├── utils/
│   ├── dungeonGen.ts     # Генерация деревни и подземелий
│   ├── gameUtils.ts      # Утилиты (коллизии, генерация лута)
│   ├── renderUtils.ts    # Рендеринг персонажей и объектов
│   ├── imageLoader.ts    # Загрузка текстур
│   ├── soundManager.ts   # Управление звуком
│   ├── spriteAnimation.ts # Анимации спрайтов
│   ├── tilesetUtils.ts   # Работа с тайлсетами
│   └── newTilesData.ts   # Данные новых тайлов
├── types.ts              # Все TypeScript типы и интерфейсы
├── constants.ts          # Константы, переводы, классы, таланты
├── App.tsx               # Корневой компонент приложения
└── Images/               # Папка с текстурами (персонажи, тайлы, животные)
```

---

## ИГРОВЫЕ СИСТЕМЫ

### 1. СИСТЕМА КЛАССОВ

Игра поддерживает **4 класса персонажей**:

1. **WARRIOR (Воин)**
   - Высокое здоровье (150 HP), низкая мана (50)
   - Базовая защита: 5, урон: 10
   - Скорость: 3
   - Способность: "Dragon Blood" (Q) - восстанавливает здоровье
   - Основной атрибут: Сила (25)

2. **ROGUE (Следопыт)**
   - Среднее здоровье (100 HP), средняя мана (80)
   - Базовая защита: 2, урон: 20
   - Скорость: 4.5
   - Способность: "Frost Arrow" (Q) - замедляет врагов
   - Основной атрибут: Ловкость (20)

3. **MAGE (Маг)**
   - Низкое здоровье (80 HP), высокая мана (150)
   - Базовая защита: 1, урон: 30
   - Скорость: 3.5
   - Способность: "Sun Strike" (Q) - взрывной урон по области
   - Основной атрибут: Интеллект (35)

4. **HOMELESS (Бомж)**
   - Среднее здоровье (120 HP), низкая мана (30)
   - Базовая защита: 3, урон: 12
   - Скорость: 3.2
   - Способность: "Бухнуть пивка" (Q) - временный бафф силы и ловкости
   - Основной атрибут: Сила (18)

**Файл:** `constants.ts` → `CLASS_STATS`

---

### 2. СИСТЕМА ПРЕДМЕТОВ

**Типы предметов:**
- `WEAPON` - оружие (увеличивает урон)
- `ARMOR` - броня (увеличивает защиту)
- `POTION` - зелья (восстанавливают здоровье/ману)

**Редкость предметов:**
- `COMMON` (Обычный) - серый
- `UNCOMMON` (Необычный) - зеленый
- `RARE` (Редкий) - синий
- `LEGENDARY` (Легендарный) - оранжевый

**Статы предметов:**
- `damage` - урон
- `defense` - защита
- `health` - здоровье
- `speed` - скорость

**Система экипировки:**
- Игрок может экипировать одно оружие и одну броню
- Предметы в инвентаре можно использовать (зелья) или экипировать (оружие/броня)
- Предметы можно продавать торговцам

**Файл:** `types.ts` → `Item`, `ItemType`, `ItemRarity`

---

### 3. СИСТЕМА ТАЛАНТОВ (СКИЛЛОВ)

Каждый класс имеет **дерево талантов** с уникальными навыками:

**Воин:**
- Железная Кожа (пассив) - +2 защиты за уровень
- Грубая Сила (пассив) - +10% урона в ближнем бою
- Кровь Дракона (модификатор способности) - улучшает способность Q

**Следопыт:**
- Скорость Ветра (пассив) - +5% скорости передвижения
- Смертоносность (пассив) - +15% критического урона
- Залп (модификатор способности) - способность Q выпускает +2 стрелы

**Маг:**
- Тайное Знание (пассив) - +1 мана реген в секунду
- Стеклянная Пушка (пассив) - +20% урона, но -10% защиты
- Метеоритный Дождь (модификатор способности) - увеличивает радиус взрыва Q

**Бомж:**
- Пьяная Сила (пассив) - +5 силы и ловкости за уровень
- Мастер Бутылок (пассив) - +15% урона от бутылок
- Пивное Бешенство (модификатор способности) - улучшает способность Q

**Типы талантов:**
- `PASSIVE` - постоянные бонусы
- `ACTIVE_MODIFIER` - модифицируют способность Q

**Файл:** `constants.ts` → `SKILL_TREES`

---

### 4. СИСТЕМА ГЛОБАЛЬНЫХ УЛУЧШЕНИЙ

**Постоянные улучшения** (сохраняются между забегами):
- Кровь Титана - +10 к максимальному здоровью (макс. 10 уровней)
- Дух Воина - +2 к урону (макс. 10 уровней)
- Жадность - +10% золота (макс. 5 уровней)
- Путник - +0.1 скорости (макс. 5 уровней)

Покупаются за глобальное золото в главном меню.

**Файл:** `constants.ts` → `GLOBAL_UPGRADES`

---

### 5. СИСТЕМА КОСМЕТИКИ

**Типы косметики:**
- `SKIN` - скины персонажей (350 золота)
- `AURA` - ауры/эффекты (1500 золота)

**Косметика по классам:**
- Воин: Золото Паладина (скин), Аура Инферно (аура)
- Следопыт: Идущий в Бездне (скин), Токсичный Туман (аура)
- Маг: Роба Архимага (скин), Эссенция Пустоты (аура)

Косметика покупается в главном меню и сохраняется между забегами.

**Файл:** `constants.ts` → `COSMETICS_CATALOG`

---

### 6. СИСТЕМА ЛОКАЦИЙ

**Деревня (Village):**
- Стартовая локация
- Генерируется процедурно с зданиями, NPC, животными
- Есть торговцы, тренер, жители
- Портал для входа в подземелья

**Подземелья (Dungeons):**
- Процедурно генерируемые уровни
- Увеличивающаяся сложность с каждым этажом
- Враги: Скелеты, Големы, Боссы
- Торговец на каждом этаже
- Портал для возврата в деревню

**Генерация:**
- Использует алгоритм для создания извилистых коридоров
- Гарантирует соединение всех комнат
- Использует только тайлы с существующими текстурами

**Файл:** `utils/dungeonGen.ts` → `generateVillage()`, `generateDungeon()`

---

### 7. СИСТЕМА NPC И ЖИВОТНЫХ

**NPC типы:**
- `MERCHANT` - торговец (привязан к зданию магазина)
- `TRAINER` - тренер (прокачка атрибутов)
- `CITIZEN` - житель
- `ELDER` - старец
- `CHILD` - ребенок

**Животные:**
- `DOG` - собака
- `CAT` - кот
- `CHICKEN` - курица
- `BIRD` - птица
- `RAT` - крыса
- `HORSE` - лошадь

**Поведение:**
- NPC и животные имеют патрульные маршруты
- Периодически останавливаются
- Движутся вокруг своей точки спавна

---

### 8. СИСТЕМА ЗДАНИЙ

**Типы зданий:**
- `ARMOR_SHOP` - магазин брони
- `WEAPON_SHOP` - магазин оружия
- `POTION_SHOP` - магазин зелий
- `TAVERN` - таверна
- `TRAINING_HALL` - зал тренировок
- `PLAYER_HOUSE` - дом игрока
- `RESIDENTIAL` - жилой дом

**Рендеринг:**
- Используется 2.5D изометрическая проекция
- Здания имеют крыши, которые скрываются при приближении камеры
- Используются текстуры из папки `Images/Tiles/`

---

### 9. СИСТЕМА БОЯ

**Механика:**
- Автоматическая атака при приближении к врагам
- Система кулдаунов для атак
- Проектили (стрелы, орбы, заклинания)
- Система агро врагов
- Враги преследуют игрока в радиусе агро

**Враги:**
- `SKELETON` - скелет (средний урон, среднее здоровье)
- `GOLEM` - голем (высокий урон, высокое здоровье)
- `BOSS` - босс (очень высокие характеристики)

**Урон и защита:**
- Урон = базовый урон + урон оружия + бонусы талантов
- Защита = базовая защита + защита брони + бонусы талантов
- Финальный урон = урон атакующего - защита цели

---

### 10. СИСТЕМА ПРОГРЕССИИ

**Опыт и уровни:**
- Опыт получается за убийство врагов
- При достижении нового уровня:
  - Восстанавливается здоровье и мана
  - Дается очко талантов
  - Увеличивается максимальное здоровье
  - Увеличивается XP для следующего уровня

**Атрибуты:**
- Сила (STR) - увеличивает урон для воина и бомжа
- Ловкость (AGI) - увеличивает урон для следопыта
- Интеллект (INT) - увеличивает урон для мага
- Очки атрибутов можно тратить у тренера

---

### 11. СИСТЕМА ПОРТАЛОВ

**Порталы:**
- Портал в подземелье - появляется в деревне после определенных условий
- Портал возврата - появляется в подземельях для возврата в деревню
- Использует текстуру `Images/Tiles/6/portal.png`
- Статичный (без анимации)

---

### 12. СИСТЕМА РЕДАКТОРА КАРТ

**Функции:**
- Редактирование стартовой локации (деревни)
- Установка тайлов, декораций, зданий
- Установка NPC, животных, порталов
- Импорт/экспорт карты в JSON
- Режим предпросмотра

**Оптимизация:**
- Отложенный рендеринг для предотвращения лагов
- Кэширование текстур
- Throttling для сохранения

**Файл:** `components/MapEditor.tsx`

---

## ТЕХНИЧЕСКИЕ ДЕТАЛИ

### Система координат и позиционирования

**Размер тайла:** 32x32 пикселя

**Центрирование объектов:**
- Все объекты (игрок, NPC, враги, животные) центрируются на тайле
- Формула центрирования: позиция 6 из 10 (≈17.78 пикселей от начала тайла)
- `TILE_CENTER_OFFSET = ((6 - 1) / (10 - 1)) * 32`

**Размер карты:**
- Ширина: 120 тайлов
- Высота: 80 тайлов
- Общий размер: 3840x2560 пикселей

**Вьюпорт:**
- Ширина: 1920 пикселей
- Высота: 1080 пикселей
- Зум камеры: 1.75

---

### Система рендеринга

**Canvas API:**
- Используется один canvas для всего рендеринга
- Изометрическая проекция для 2.5D эффекта
- Система слоев (z-ordering) для правильного отображения глубины

**Оптимизация:**
- Кэширование текстур
- Отсечение невидимых объектов (frustum culling)
- Батчинг рендеринга
- Отложенная загрузка текстур

**Анимации:**
- Спрайт-листы для персонажей и врагов
- Система фреймов для анимаций
- Плавные переходы между состояниями

**Файл:** `utils/renderUtils.ts`, `utils/spriteAnimation.ts`

---

### Система коллизий

**Блокирующие объекты:**
- Стены (`type: 'WALL'`)
- Здания (`buildingId` присутствует)
- Декорации: камни, деревья, кусты, заборы, костры и т.д.
- Текстуры с префиксами: `STONE_`, `BOX_`, `HOUSE_OBJ_`, `TENT_`, `RUINS_`, `DECOR_`, `GRASS_OBJ_`

**Проверка коллизий:**
- Проверяются все 4 угла объекта
- Используется сетка тайлов для оптимизации

**Файл:** `utils/gameUtils.ts` → `checkCollision()`

---

### Система звука

**Менеджер звука:**
- Управление фоновой музыкой
- Звуковые эффекты (атаки, шаги, взаимодействия)
- Настройка громкости (мастер и музыка отдельно)
- Атмосферные звуки для подземелий

**Файл:** `utils/soundManager.ts`

---

### Система сохранений

**LocalStorage:**
- Глобальное сохранение (`dungeon_save_v2`):
  - Баланс золота
  - Купленная косметика
  - Экипированная косметика
  - Глобальные улучшения
- Настройки игры:
  - Разрешение экрана
  - VSync
  - Громкость звука и музыки
  - Язык интерфейса
  - Привязки клавиш

**Файл:** `App.tsx` → `useLocalStorage` hook

---

### Система переводов

**Поддерживаемые языки:**
- Русский (RU) - по умолчанию
- Английский (EN)

**Переводы включают:**
- Все тексты интерфейса
- Названия классов, предметов, талантов
- Сообщения в игре
- Описания способностей

**Файл:** `constants.ts` → `TRANSLATIONS`

---

### Система управления

**Привязки клавиш (по умолчанию):**
- W/A/S/D - движение
- E - взаимодействие
- I - инвентарь
- Q - способность
- Space - поднять предмет
- K - таланты

**Настройка:**
- Все клавиши можно переназначить в настройках
- Сохраняются в LocalStorage

**Файл:** `constants.ts` → `DEFAULT_KEYBINDINGS`

---

## ОСОБЕННОСТИ РЕАЛИЗАЦИИ

### 1. Изометрическая проекция
- Используется 30-градусная изометрическая проекция
- Правильная обработка глубины (z-ordering)
- 2.5D эффект для зданий и объектов

### 2. Процедурная генерация
- Деревня генерируется с зданиями, дорогами, NPC
- Подземелья генерируются с гарантированным соединением всех комнат
- Используется детерминированный рандом для воспроизводимости

### 3. Система текстур
- Загрузка текстур из папки `Images/`
- Кэширование загруженных текстур
- Поддержка спрайт-листов
- Обработка прозрачности

### 4. Оптимизация производительности
- Использование `useRef` для избежания лишних ре-рендеров
- Мемоизация компонентов
- Отложенный рендеринг в редакторе карт
- Оптимизация коллизий через сетку

### 5. Модальные окна
- Инвентарь, магазин, таланты, тренер открываются поверх игры
- Игра ставится на паузу при открытии модальных окон
- Без перезагрузки текстур при открытии/закрытии окон

---

## СТРУКТУРА ДАННЫХ

### Player (Игрок)
```typescript
{
  id: string;
  x, y, width, height: number;
  classType: ClassType;
  health, maxHealth: number;
  mana, maxMana: number;
  speed: number;
  level: number;
  xp, xpToNext: number;
  gold: number;
  inventory: Item[];
  equipped: { weapon: Item | null, armor: Item | null };
  stats: { damage, defense, health };
  attributes: { strength, agility, intelligence, primary };
  attributePoints: number;
  cooldowns: { attack, special };
  skillPoints: number;
  learnedSkills: { [skillId: string]: number };
}
```

### Tile (Тайл)
```typescript
{
  x, y: number;
  type: 'FLOOR' | 'WALL' | 'EXIT' | 'DOOR' | 'PORTAL' | 'RETURN_PORTAL';
  terrain: TerrainType;
  visible: boolean;
  explored: boolean;
  variant: number;
  decoration?: 'NONE' | 'GRASS' | 'STONE' | 'TREE' | ...;
  roof?: 'NONE' | 'H_TOP' | 'H_BOTTOM' | ...;
  buildingId?: number;
  spriteIndex?: number;
}
```

### Enemy (Враг)
```typescript
{
  id: string;
  x, y, width, height: number;
  type: 'SKELETON' | 'GOLEM' | 'BOSS';
  health, maxHealth: number;
  damage: number;
  aggroRange: number;
  attackRange: number;
  attackCooldown: number;
  currentCooldown: number;
}
```

---

## ВАЖНЫЕ КОНСТАНТЫ

```typescript
TILE_SIZE = 32
MAP_WIDTH = 120
MAP_HEIGHT = 80
VIEWPORT_WIDTH = 1920
VIEWPORT_HEIGHT = 1080
CAMERA_ZOOM = 1.75
```

---

## ЗАПУСК ПРОЕКТА

```bash
npm install
npm run dev
```

Игра запускается на `http://localhost:3000/`

---

## ОСОБЕННОСТИ КОДА

1. **Использование useRef** - для избежания лишних ре-рендеров игрового состояния
2. **Мемоизация** - компоненты обернуты в `memo()` где необходимо
3. **Callback hooks** - использование `useCallback` для стабильности ссылок
4. **Canvas рендеринг** - весь игровой мир рендерится на Canvas, а не через DOM
5. **Модульная архитектура** - разделение на утилиты, компоненты, типы

---

## ИЗВЕСТНЫЕ ОСОБЕННОСТИ

1. **Центрирование объектов** - все объекты центрируются на позиции 6 из 10 в тайле (≈17.78px от начала)
2. **Редактор карт** - оптимизирован для предотвращения лагов при редактировании
3. **Модальные окна** - открываются поверх игры без перезагрузки текстур
4. **Система порталов** - статичные порталы для перехода между локациями
5. **Процедурная генерация** - гарантирует соединение всех комнат в подземельях

---

## ЗАВИСИМОСТИ

```json
{
  "react": "^19.2.1",
  "react-dom": "^19.2.1",
  "lucide-react": "^0.556.0",
  "typescript": "~5.8.2",
  "vite": "^6.2.0"
}
```

---

Это полное описание игры "Долговая Яма". Используй этот промпт для объяснения всех аспектов игры в одном сообщении.

